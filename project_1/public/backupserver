const express = require('express');
const Bytez = require('bytez.js');
const path = require('path');
const app = express();

const API_KEY = "1fd43e8593a407cf7db04a1a0820fb45";
const sdk = new Bytez(API_KEY);
const model = sdk.model("Qwen/Qwen3-4B-Instruct-2507");

app.use(express.json());
app.use(express.static(path.join(__dirname, 'public')));

app.post('/api/chat', async (req, res) => {
  try {
    const userMessage = req.body.message;
    
    if (!userMessage || userMessage.trim() === '') {
      return res.status(400).json({ error: 'الرجاء إدخال رسالة' });
    }

    const { error, output } = await model.run([
      {
        "role": "user",
        "content": userMessage
      }
    ]);

    if (error) {
      return res.status(500).json({ error: 'حدث خطأ في النموذج' });
    }

    console.log('نوع output:', typeof output);
    console.log('output:', output);
    
    let responseText = '';
    
    if (typeof output === 'string') {
      responseText = output;
    } else {
      responseText = JSON.stringify(output, null, 2);
    }
    
    res.json({ 
      response: responseText 
    });
    
  } catch (err) {
    console.error('خطأ:', err);
    res.status(500).json({ error: 'حدث خطأ في الخادم' });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`port work in http://localhost:${PORT}`);
});



document.addEventListener("DOMContentLoaded", () => {
    const chat = document.getElementById("chatMessages");
    const input = document.getElementById("userInput");
    const btn = document.getElementById("sendButton");

    function addMessage(text, user = false) {
        const div = document.createElement("div");
        div.className = "message " + (user ? "user" : "bot");
        div.textContent = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage() {
        const msg = input.value.trim();
        if (!msg) return;

        addMessage(msg, true);
        input.value = "";
        btn.disabled = true;

        const loading = document.createElement("div");
        loading.className = "message bot";
        loading.textContent = "خمسايه كدا افكر....";
        loading.id = "loading";
        chat.appendChild(loading);

        try {
            const res = await fetch("/api/chat", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ message: msg })
            });

            const data = await res.json();
            document.getElementById("loading")?.remove();

            addMessage(data.response || "فيه خطا حاول تاني");
        } catch {
            document.getElementById("loading")?.remove();
            addMessage("خطأ في الاتصال بالسيرفر.");
        }

        btn.disabled = false;
        input.focus();
    }

    btn.addEventListener("click", sendMessage);
    input.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    input.focus();
});
